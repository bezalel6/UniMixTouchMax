# Custom JTAG configuration for ESP32-S3 with custom pins
transport select jtag

# Set slower initial speed
adapter speed 100

# Include the standard ESP32-S3 configuration first
source [find target/esp32s3.cfg]

# Explicitly set the target name (esp32s3.cfg should have set this)
set _TARGETNAME esp32s3

# Configure custom JTAG pins
$_TARGETNAME configure -event reset-init {
    echo "Configuring custom JTAG pins: TCK=1, TDO=2, TDI=17, TMS=18"
    
    # Configure GPIO matrix for JTAG routing
    # Route JTAG signals to custom pins
    mww 0x60004000 0x50    # TCK to GPIO1
    mww 0x600040DC 0x02    # TDO from GPIO2  
    mww 0x60004044 0x51    # TDI to GPIO17
    mww 0x60004048 0x52    # TMS to GPIO18
    
    # Configure GPIO pads as outputs/inputs
    mww 0x60004020 0x3000  # GPIO1 as output (TCK)
    mww 0x60004024 0x2000  # GPIO2 as input (TDO)
    mww 0x60004064 0x3000  # GPIO17 as output (TDI)  
    mww 0x60004068 0x3000  # GPIO18 as output (TMS)
}

# Increase speed after successful connection
$_TARGETNAME configure -event examine-end {
    echo "JTAG connection established, increasing speed"
    adapter speed 500
}

# Configure for custom JTAG pins on ESP32-S3 side
$_TARGETNAME configure -event reset-init {
    # Configure ESP32-S3 to use custom JTAG pins
    # Set JTAG clock pin (GPIO1)
    mww 0x60004020 [expr {(1 << 9) | (1 << 8)}]  # Output enable + function select
    # Set JTAG data output pin (GPIO2) 
    mww 0x60004024 [expr {(1 << 8)}]  # Input enable
    # Set JTAG data input pin (GPIO17)
    mww 0x60004064 [expr {(1 << 9) | (1 << 8)}]  # Output enable + function select  
    # Set JTAG mode select pin (GPIO18)
    mww 0x60004068 [expr {(1 << 9) | (1 << 8)}]  # Output enable + function select
    
    # Configure GPIO matrix for JTAG routing
    # Route JTAG signals to custom pins
    mww 0x60004000 [expr {0x50}]  # TCK to GPIO1
    mww 0x600040DC [expr {0x02}]  # TDO from GPIO2
    mww 0x60004044 [expr {0x51}]  # TDI to GPIO17  
    mww 0x60004048 [expr {0x52}]  # TMS to GPIO18
}

# Increase speed after connection established
$_TARGETNAME configure -event examine-end {
    adapter speed 500
}
